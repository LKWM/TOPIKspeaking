<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exercice 1 - Comprendre les questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Noto+Sans:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
            overflow: hidden;
            touch-action: manipulation;
        }

        .slide-enter { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* Responsive Text Classes */
        .text-fluid-xs { font-size: clamp(0.75rem, 1.5vh, 1rem); }
        .text-fluid-sm { font-size: clamp(0.875rem, 2vh, 1.25rem); }
        .text-fluid-base { font-size: clamp(1rem, 2.5vh, 1.5rem); }
        .text-fluid-lg { font-size: clamp(1.25rem, 3.5vh, 2.25rem); }
        .text-fluid-xl { font-size: clamp(1.75rem, 5vh, 4rem); }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center bg-slate-100 text-slate-800 md:p-4">

    <!-- Main Container -->
    <div id="app-container" class="relative w-full h-full bg-white md:rounded-2xl shadow-2xl overflow-hidden flex flex-col max-w-[1920px] mx-auto">
        
        <!-- Progress Bar -->
        <div class="h-1.5 w-full bg-slate-100 shrink-0">
            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: 0%"></div>
        </div>

        <!-- Content Area -->
        <main id="content-area" class="flex-grow flex flex-col items-center justify-center p-4 md:p-8 relative overflow-hidden">
            <!-- Content Injected Here -->
        </main>

        <!-- Footer -->
        <footer class="h-[10vh] max-h-20 w-full bg-white border-t border-slate-100 flex items-center justify-between px-6 md:px-10 z-10 shrink-0">
            <button id="prev-btn" class="flex items-center gap-2 text-slate-500 hover:text-indigo-600 font-medium transition-colors opacity-0 pointer-events-none">
                <i data-lucide="arrow-left" class="w-[2.5vh] h-[2.5vh]"></i>
                <span class="hidden md:inline text-fluid-sm">Précédent</span>
            </button>
            <div class="text-xs md:text-sm text-slate-300 font-medium tracking-widest absolute left-1/2 transform -translate-x-1/2 pointer-events-none">CORÉENO</div>
            <button id="next-btn" class="group flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-200 disabled:opacity-50 text-fluid-sm">
                <span>Suivant</span>
                <i data-lucide="arrow-right" class="w-[2.5vh] h-[2.5vh] group-hover:translate-x-1 transition-transform"></i>
            </button>
        </footer>
    </div>

    <audio id="lesson-audio" class="hidden"></audio>

    <script>
        // --- Data ---
        const questionsData = [
            { id: 1, audioSrc: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782322/Q_ex_1_vaj6tr.mp3", koreanText: "가장 친한 친구가 누구예요? 그 친구에 대해 이야기하세요.", frenchText: "Qui est votre meilleur ami ? Parlez de cet ami.", topic: "친구", tense: "현재", optionsTopic: ["친구", "여행", "가족", "공부"], optionsTense: ["과거", "미래", "현재"] },
            { id: 2, audioSrc: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785142/Q_ex_2_oi4b89.mp3", koreanText: "어디에 여행을 가고 싶어요? 하고 싶은 여행에 대해 이야기하세요.", frenchText: "Où voulez-vous voyager ? Parlez du voyage que vous souhaitez faire.", topic: "여행", tense: "미래", optionsTopic: ["집", "나라", "여행", "이름"], optionsTense: ["과거", "미래", "현재"] },
            { id: 3, audioSrc: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785155/Q_ex_3_xoofmk.mp3", koreanText: "시간이 있을 때 무엇을 해요? 좋아하는 활동에 대해 이야기하세요.", frenchText: "Que faites-vous quand vous avez du temps libre ? Parlez de vos activités préférées.", topic: "취미", tense: "현재", optionsTopic: ["옷", "취미", "공부", "선물"], optionsTense: ["과거", "미래", "현재"] },
            { id: 4, audioSrc: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785165/Q_ex_4_warvot.mp3", koreanText: "내일은 친구의 생일이에요. 생일 파티 계획에 대해 이야기하세요.", frenchText: "Demain, c'est l'anniversaire d'un ami. Parlez de vos projets pour la fête d'anniversaire.", topic: "생일", tense: "미래", optionsTopic: ["생일", "가족", "경험", "날짜"], optionsTense: ["과거", "미래", "현재"] },
            { id: 5, audioSrc: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785176/Q_ex_5_khlnli.mp3", koreanText: "친구와 싸운 적이 있어요? 그 경험에 대해 이야기하세요.", frenchText: "Vous êtes-vous déjà disputé avec un ami ? Parlez de cette expérience.", topic: "경험", tense: "과거", optionsTopic: ["경험", "칭찬", "여행", "선물"], optionsTense: ["과거", "미래", "현재"] }
        ];

        const slides = [
            { type: 'cover', title: "Exercice 1 - 질문 이해하기", subtitle: "Exercice 1 - Comprendre les questions" },
            { type: 'text', content: `
                <!-- Compacted & Centered Layout -->
                <div class="flex flex-col items-center justify-center h-full w-full max-w-4xl px-4 animate-fade-in">
                    <div class="bg-indigo-50 p-[3vh] rounded-full mb-[3vh]">
                        <i data-lucide="headphones" class="w-[8vh] h-[8vh] text-indigo-600"></i>
                    </div>
                    <div class="text-center space-y-[2vh]">
                        <p class="text-fluid-lg leading-snug text-slate-800">
                            Dans l'examen oral du TOPIK, toutes les questions sont <br><strong class="text-indigo-600">audio uniquement</strong>.
                        </p>
                        <p class="text-fluid-base text-slate-500 font-medium">
                            Écoutez attentivement et identifiez le <span class="font-bold text-slate-700">sujet</span>.
                        </p>
                    </div>
                </div>`
            },
            ...questionsData.map(q => ({ type: 'quiz', mode: 'topic', data: q, instruction: "Choisissez le <span class='text-indigo-600 font-bold'>sujet</span>.", correctAnswer: q.topic, options: q.optionsTopic })),
            { 
                type: 'text', 
                title: "Attention aux temps verbaux",
                content: `
                    <!-- Fixed Alignment and Text Sizes -->
                    <div class="flex flex-col items-center justify-center w-full max-w-5xl gap-[3vh] px-4">
                        <p class="text-fluid-base leading-relaxed text-slate-700 text-center font-medium">
                            Le temps verbal à utiliser dépend de la question.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-[2vh] w-full">
                            <div class="bg-blue-50 p-[3vh] rounded-2xl border border-blue-100 flex flex-col justify-center text-center transition-transform hover:scale-[1.01]">
                                <p class="font-bold text-blue-800 mb-2 text-fluid-base">Passé (과거)</p>
                                <p class="text-fluid-sm text-blue-600">Questions sur des expériences passées.</p>
                            </div>
                            <div class="bg-green-50 p-[3vh] rounded-2xl border border-green-100 flex flex-col justify-center text-center transition-transform hover:scale-[1.01]">
                                <p class="font-bold text-green-800 mb-2 text-fluid-base">Présent (현재)</p>
                                <p class="text-fluid-sm text-green-600">Préférences générales ou activités quotidiennes.</p>
                            </div>
                            <div class="bg-purple-50 p-[3vh] rounded-2xl border border-purple-100 flex flex-col justify-center text-center transition-transform hover:scale-[1.01]">
                                <p class="font-bold text-purple-800 mb-2 text-fluid-base">Futur (미래)</p>
                                <p class="text-fluid-sm text-purple-600">Questions sur des projets ou des souhaits.</p>
                            </div>
                        </div>
                        <p class="text-fluid-sm text-slate-500 mt-[1vh] text-center max-w-3xl">
                            * Les locuteurs de niveau intermédiaire/avancé doivent savoir identifier et utiliser le temps correct.
                        </p>
                    </div>
                `
            },
            ...questionsData.map(q => ({ type: 'quiz', mode: 'tense', data: q, instruction: "Choisissez le <span class='text-indigo-600 font-bold'>temps</span>.", correctAnswer: q.tense, options: q.optionsTense })),
            { type: 'outro', content: `<div class="flex flex-col items-center justify-center h-full text-center max-w-3xl gap-[3vh]"><div class="p-[3vh] bg-green-100 rounded-full text-green-600 animate-bounce"><i data-lucide="check-circle-2" class="w-[10vh] h-[10vh]"></i></div><p class="text-fluid-xl text-slate-600 font-bold">Vous avez terminé l'exercice !</p><p class="text-fluid-lg text-slate-500">Dans l'<span class="font-bold text-indigo-600">&lt;Exercice 2&gt;</span>, nous nous entraînerons à planifier les détails de chaque réponse.</p></div>` }
        ];

        // State Management
        let currentIndex = 0;
        let isAudioInitialized = false;
        // Initialize state for each slide
        const slideStates = slides.map(() => ({ isSolved: false, attempts: 0 }));

        const contentArea = document.getElementById('content-area');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const progressBar = document.getElementById('progress-bar');
        const audioEl = document.getElementById('lesson-audio');

        async function initAudio() { if (!isAudioInitialized) { await Tone.start(); isAudioInitialized = true; } }

        function playSound(type) {
            if (!isAudioInitialized) return;
            const synth = new Tone.MembraneSynth().toDestination();
            const poly = new Tone.PolySynth().toDestination();
            const melody = new Tone.Synth().toDestination();
            switch(type) {
                case 'click': synth.triggerAttackRelease("C2", "32n"); break;
                case 'correct': poly.triggerAttackRelease(["C5", "E5", "G5"], "8n"); break;
                case 'wrong': synth.triggerAttackRelease("C2", "16n"); setTimeout(()=>synth.triggerAttackRelease("B1", "16n"),100); break;
                case 'complete': const now = Tone.now(); melody.triggerAttackRelease("C5","8n",now); melody.triggerAttackRelease("E5","8n",now+.1); melody.triggerAttackRelease("G5","8n",now+.2); melody.triggerAttackRelease("C6","4n",now+.3); break;
            }
        }

        function toggleAudio(src, btnId) {
            const btn = document.getElementById(btnId);
            if (!src) return;
            if (audioEl.src !== src) { audioEl.src = src; audioEl.load(); }
            if (audioEl.paused) {
                audioEl.play();
                btn.classList.add('animate-pulse', 'ring-4', 'ring-indigo-200');
                btn.innerHTML = `<i data-lucide="pause" class="w-full h-full text-white p-3"></i>`;
                lucide.createIcons();
            } else {
                audioEl.pause();
                btn.classList.remove('animate-pulse', 'ring-4', 'ring-indigo-200');
                btn.innerHTML = `<i data-lucide="play" class="w-full h-full text-white ml-1 p-3"></i>`;
                lucide.createIcons();
            }
            audioEl.onended = () => {
                btn.classList.remove('animate-pulse', 'ring-4', 'ring-indigo-200');
                btn.innerHTML = `<i data-lucide="play" class="w-full h-full text-white ml-1 p-3"></i>`;
                lucide.createIcons();
            };
        }

        function checkAnswer(selectedOption, correctOption, btnElement) {
            const currentState = slideStates[currentIndex];
            if (currentState.isSolved) return;

            btnElement.classList.remove('hover:border-indigo-300', 'hover:bg-indigo-50');

            if (selectedOption === correctOption) {
                currentState.isSolved = true;
                playSound('correct');
                // Force UI update directly for instant feedback
                btnElement.className = "option-btn border-2 font-bold h-[10vh] rounded-xl text-fluid-base transition-all shadow-sm bg-green-500 text-white border-green-500 scale-[1.02]";
                
                // Show Explanation
                const textContainer = document.getElementById('text-reveal-container');
                if(textContainer) {
                    textContainer.innerHTML = getExplanationHTML(slides[currentIndex].data);
                }
                
                // Enable Next Button
                updateNavigation();
            } else {
                playSound('wrong');
                currentState.attempts++;
                btnElement.classList.add('shake', 'bg-red-50', 'border-red-200', 'text-red-500');
                setTimeout(() => btnElement.classList.remove('shake'), 500);
                updateHintUI();
            }
        }

        function getExplanationHTML(data) {
            return `
                <div class="bg-indigo-50 p-4 rounded-xl text-center w-full animate-fade-in border border-indigo-100 shadow-sm">
                    <p class="font-bold text-slate-800 text-fluid-base mb-2 leading-snug">${data.koreanText}</p>
                    <p class="text-fluid-sm text-indigo-600">${data.frenchText}</p>
                </div>`;
        }

        function updateHintUI() {
            const hintArea = document.getElementById('hint-area');
            if(!hintArea) return;
            
            const slideData = slides[currentIndex].data;
            const currentState = slideStates[currentIndex];

            if (currentState.attempts >= 1 && !document.getElementById('hint-btn-text')) {
                const btn = document.createElement('button');
                btn.id = 'hint-btn-text';
                btn.className = "text-fluid-sm font-bold text-indigo-600 underline hover:text-indigo-800 py-1";
                btn.textContent = "Lire le texte (Indice)";
                btn.onclick = () => {
                    const display = document.getElementById('text-display');
                    display.classList.remove('hidden');
                    display.querySelector('.korean').textContent = slideData.koreanText;
                    btn.style.display = 'none';
                };
                hintArea.appendChild(btn);
            }
            if (currentState.attempts >= 2 && !document.getElementById('hint-btn-trans')) {
                const btn = document.createElement('button');
                btn.id = 'hint-btn-trans';
                btn.className = "text-fluid-sm font-bold text-slate-500 underline mt-1 hover:text-slate-700 py-1";
                btn.textContent = "Voir la traduction";
                btn.onclick = () => {
                     const display = document.getElementById('text-display');
                     display.classList.remove('hidden');
                     display.querySelector('.french').textContent = slideData.frenchText;
                     display.querySelector('.french').classList.remove('hidden');
                     btn.style.display = 'none';
                };
                hintArea.appendChild(btn);
            }
        }

        function renderSlide(index) {
            audioEl.pause();
            audioEl.currentTime = 0;
            
            const slide = slides[index];
            const currentState = slideStates[index];
            
            contentArea.innerHTML = ''; 

            const container = document.createElement('div');
            // Unified container style
            container.className = 'w-full h-full flex flex-col items-center justify-center slide-enter gap-[2vh]';

            if (slide.type === 'cover') {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full w-full pb-[10vh]">
                        <div class="p-[3vh] bg-indigo-50 rounded-full shadow-sm mb-[4vh]">
                            <i data-lucide="headphones" class="w-[10vh] h-[10vh] text-indigo-600"></i>
                        </div>
                        <h1 class="text-fluid-xl font-black text-center text-slate-800 mb-[2vh] leading-tight tracking-tight">${slide.title}</h1>
                        <p class="text-fluid-lg text-slate-500 font-medium text-center">${slide.subtitle}</p>
                    </div>
                `;
                nextBtn.innerHTML = `<span>Commencer</span> <i data-lucide="arrow-right" class="w-[2.5vh] h-[2.5vh]"></i>`;
            }
            else if (slide.type === 'text' || slide.type === 'outro') {
                if(slide.title) container.innerHTML = `<h2 class="text-fluid-lg font-bold text-slate-800 text-center mb-[2vh]">${slide.title}</h2>`;
                container.innerHTML += slide.content;
            }
            else if (slide.type === 'quiz') {
                const btnId = `quiz-audio-${index}`;
                
                // Determine content for reveal area based on saved state
                let revealContent = '';
                if (currentState.isSolved) {
                    revealContent = getExplanationHTML(slide.data);
                } else {
                    revealContent = `
                        <div id="hint-area" class="flex flex-col items-center gap-2"></div>
                        <div id="text-display" class="hidden bg-slate-50 p-4 rounded-xl text-center w-full border border-slate-200 animate-fade-in shadow-sm">
                             <p class="korean font-bold text-slate-800 text-fluid-base mb-1"></p>
                             <p class="french text-fluid-sm text-indigo-600 hidden"></p>
                        </div>`;
                }

                container.classList.remove('justify-center');
                container.classList.add('justify-evenly'); // Spread vertically for quiz

                container.innerHTML = `
                    <p class="text-fluid-lg text-slate-600 text-center max-w-4xl px-4 font-medium">${slide.instruction}</p>
                    
                    <button id="${btnId}" onclick="toggleAudio('${slide.data.audioSrc}', '${btnId}')" class="w-[15vh] h-[15vh] rounded-full bg-indigo-500 hover:bg-indigo-600 text-white flex items-center justify-center shadow-xl transition-all active:scale-95 ring-offset-4 outline-none">
                        <i data-lucide="play" class="w-[6vh] h-[6vh] ml-1"></i>
                    </button>

                    <!-- Text Reveal Container (State-aware) -->
                    <div id="text-reveal-container" class="w-full min-h-[15vh] flex flex-col items-center justify-center max-w-4xl px-4">
                         ${revealContent}
                    </div>

                    <!-- Options -->
                    <div class="grid grid-cols-2 gap-[2vh] w-full max-w-4xl px-2">
                        ${slide.options.map(opt => {
                            let extraClass = "bg-white border-slate-200 text-slate-700 hover:border-indigo-300 hover:bg-indigo-50";
                            // Apply solved styling immediately if solved
                            if (currentState.isSolved && opt === slide.correctAnswer) {
                                extraClass = "bg-green-500 text-white border-green-500 scale-[1.02]";
                            }
                            // Disable click if solved
                            const clickHandler = currentState.isSolved ? '' : `onclick="checkAnswer('${opt}', '${slide.correctAnswer}', this)"`;
                            
                            return `
                            <button class="option-btn border-2 font-bold h-[10vh] rounded-xl text-fluid-base transition-all shadow-sm ${extraClass}"
                                ${clickHandler}>
                                ${opt}
                            </button>
                        `}).join('')}
                    </div>
                `;
                
                // If not solved but attempts exist, restore hint buttons
                if (!currentState.isSolved) {
                    setTimeout(() => updateHintUI(), 0);
                }
            }

            contentArea.appendChild(container);
            updateNavigation();
            lucide.createIcons();
            
            window.toggleAudio = toggleAudio;
            window.checkAnswer = checkAnswer;
        }

        function updateNavigation() {
            // Prev Button Visibility
            if (currentIndex === 0) prevBtn.classList.add('opacity-0', 'pointer-events-none');
            else prevBtn.classList.remove('opacity-0', 'pointer-events-none');

            const slide = slides[currentIndex];
            const currentState = slideStates[currentIndex];

            // Next Button State Logic
            if (currentIndex === slides.length - 1) {
                 nextBtn.innerHTML = `<span>Terminer</span> <i data-lucide="check" class="w-[2.5vh] h-[2.5vh]"></i>`;
                 nextBtn.className = "group flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-full font-semibold transition-all shadow-lg shadow-green-200 text-fluid-sm";
                 nextBtn.disabled = false;
                 nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                 nextBtn.innerHTML = `<span>Suivant</span> <i data-lucide="arrow-right" class="w-[2.5vh] h-[2.5vh] group-hover:translate-x-1 transition-transform"></i>`;
                 nextBtn.className = "group flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full font-semibold transition-all active:scale-95 shadow-lg shadow-indigo-200 text-fluid-sm";
                 
                 // If slide is a quiz AND not solved yet, disable next
                 if (slide.type === 'quiz' && !currentState.isSolved) {
                     nextBtn.disabled = true;
                     nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                     nextBtn.classList.remove('animate-bounce');
                 } else {
                     // Solved or not a quiz -> enable next
                     nextBtn.disabled = false;
                     nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                 }
            }
            updateProgress();
        }

        function updateProgress() { progressBar.style.width = `${((currentIndex + 1) / slides.length) * 100}%`; }

        nextBtn.addEventListener('click', async () => {
            if (!isAudioInitialized) await initAudio();
            if (currentIndex === slides.length - 1) {
                playSound('complete');
                window.parent.postMessage({ type: 'lesson_complete' }, '*');
                nextBtn.disabled = true;
                nextBtn.innerHTML = `<span>Terminé !</span>`;
                return;
            }
            playSound('click');
            currentIndex++;
            renderSlide(currentIndex);
        });

        prevBtn.addEventListener('click', () => { 
            if (currentIndex > 0) { 
                currentIndex--; 
                renderSlide(currentIndex); 
            } 
        });

        renderSlide(currentIndex);
        updateProgress();
    </script>
</body>
</html>
