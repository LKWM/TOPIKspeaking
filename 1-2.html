<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exercice 1 - 질문 이해하기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563EB;
            --secondary-color: #10B981;
            --bg-color: #F8FAFC;
            --text-main: #1E293B;
            --error-color: #EF4444;
        }
        
        body {
            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-main);
        }

        #app-container {
            background-color: var(--bg-color);
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Aspect Ratio Logic */
        @media (min-aspect-ratio: 16/9) {
            #app-container { width: 100vh; height: 56.25vh; max-width: 177.78vh; }
        }
        @media (max-aspect-ratio: 16/9) {
            #app-container { width: 100vw; height: 56.25vw; }
        }
        .mobile-mode #app-container { width: 100vw; height: 100vh; max-width: none; max-height: none; }

        /* Transitions */
        .fade-enter-active { opacity: 1; transition: opacity 0.3s ease-in-out; }
        .fade-enter { opacity: 0; }
        
        /* Audio Animation */
        .playing-wave { display: flex; align-items: center; justify-content: center; gap: 2px; }
        .playing-wave span {
            width: 3px; height: 12px; background-color: white;
            animation: wave 1s infinite ease-in-out; border-radius: 2px;
        }
        .playing-wave span:nth-child(2) { animation-delay: 0.1s; }
        .playing-wave span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes wave { 0%, 100% { height: 12px; } 50% { height: 20px; } }

        /* Quiz Styles */
        .option-btn {
            transition: all 0.2s;
            border: 2px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .option-btn:hover:not(:disabled) { border-color: var(--primary-color); background-color: #EFF6FF; }
        .option-btn.selected { border-color: var(--primary-color); background-color: #EFF6FF; color: var(--primary-color); font-weight: bold; }
        .option-btn.correct { border-color: var(--secondary-color); background-color: #ECFDF5; color: var(--secondary-color); }
        .option-btn.wrong { border-color: var(--error-color); background-color: #FEF2F2; color: var(--error-color); animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .korean-text { font-family: 'Noto Sans KR', sans-serif; word-break: keep-all; }
        
        .hint-btn {
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: underline;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
            padding: 0.5rem;
        }
        
        /* Custom scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div id="app-container" class="w-full h-full relative">
        <!-- Header -->
        <header class="h-12 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-10">
            <div class="flex items-center gap-2 text-blue-600 font-bold">
                <i class="ph-fill ph-chat-circle-text text-xl"></i>
                <span class="text-sm tracking-wide">TOPIK 말하기</span>
            </div>
            <div class="text-xs text-gray-400 font-medium">Exercice 1</div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 relative w-full mx-auto overflow-hidden bg-white">
            <!-- Dynamic Content -->
        </main>

        <!-- Footer -->
        <footer id="footer-nav" class="h-16 bg-white border-t border-gray-200 flex items-center justify-between px-4 sm:px-8 shrink-0 z-10 relative">
            <div class="absolute top-0 left-0 h-1 bg-gray-100 w-full">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
            </div>

            <button id="prev-btn" onclick="prevSlide()" class="flex items-center gap-2 text-gray-500 font-medium px-4 py-2 rounded-lg hover:bg-gray-100 disabled:opacity-30 transition-colors" disabled>
                <i class="ph-bold ph-arrow-left"></i>
                <span class="hidden sm:inline">Précédent</span>
            </button>

            <span id="page-indicator" class="text-sm font-semibold text-gray-600 font-mono">1 / 13</span>

            <button id="next-btn" onclick="nextSlide()" class="flex items-center gap-2 bg-blue-600 text-white font-medium px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="hidden sm:inline">Suivant</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
        </footer>
    </div>

    <script>
        // --- DATA ---
        const slides = [
            {
                type: "cover",
                title: "Exercice 1 - 질문 이해하기",
                subtitle: "Comprendre la question",
                desc: "",
                icon: "ph-ear"
            },
            {
                type: "info",
                title: "Consignes",
                content: "Dans l'épreuve orale du TOPIK, toutes les questions sont posées sous forme audio. Vous ne pouvez écouter la question qu'une seule fois.<br><br>Écoutez attentivement et <strong>identifiez le sujet</strong>.",
                icon: "ph-info"
            },
            // PART 1: Identify Topic (Questions 1-5)
            {
                type: "quiz",
                mode: "topic",
                instruction: "Écoutez la question et choisissez le sujet approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782322/Q_ex_1_vaj6tr.mp3",
                text: "가장 친한 친구가 누구예요? 그 친구에 대해 이야기하세요.",
                translation: "Qui est votre meilleur ami ? Parlez de cet ami.",
                options: ["친구", "여행", "가족", "공부"],
                answer: "친구"
            },
            {
                type: "quiz",
                mode: "topic",
                instruction: "Écoutez la question et choisissez le sujet approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785142/Q_ex_2_oi4b89.mp3",
                text: "어디에 여행을 가고 싶어요? 하고 싶은 여행에 대해 이야기하세요.",
                translation: "Où voulez-vous aller en voyage ? Parlez du voyage que vous désirez faire.",
                options: ["집", "나라", "여행", "이름"],
                answer: "여행"
            },
            {
                type: "quiz",
                mode: "topic",
                instruction: "Écoutez la question et choisissez le sujet approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785155/Q_ex_3_xoofmk.mp3",
                text: "시간이 있을 때 뭘 해요? 좋아하는 활동에 대해 이야기하세요.",
                translation: "Que faites-vous quand vous avez du temps ? Parlez des activités que vous aimez.",
                options: ["옷", "취미", "공부", "선물"],
                answer: "취미"
            },
            {
                type: "quiz",
                mode: "topic",
                instruction: "Écoutez la question et choisissez le sujet approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785165/Q_ex_4_warvot.mp3",
                text: "내일은 친구의 생일이에요. 생일 파티 계획에 대해 이야기하세요.",
                translation: "Demain, c'est l'anniversaire d'un ami. Parlez des projets pour la fête d'anniversaire.",
                options: ["생일", "가족", "경험", "날짜"],
                answer: "생일"
            },
            {
                type: "quiz",
                mode: "topic",
                instruction: "Écoutez la question et choisissez le sujet approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785176/Q_ex_5_khlnli.mp3",
                text: "친구와 싸운 적이 있어요? 그 경험에 대해 이야기하세요.",
                translation: "Vous êtes-vous déjà disputé avec un ami ? Parlez de cette expérience.",
                options: ["경험", "칭찬", "여행", "선물"],
                answer: "경험"
            },
            // Bridge: Tense Intro
            {
                type: "info",
                title: "Le Temps", 
                content: "Le temps verbal change selon la question. Certaines questions portent sur des expériences passées, d'autres sur des projets futurs.<br><br>Si vous êtes de niveau intermédiaire/avancé, vous devez savoir utiliser différents temps verbaux.",
                icon: "ph-clock-countdown"
            },
            // PART 2: Identify Tense (Questions 6-10 / Reusing Audios 1-5)
            {
                type: "quiz",
                mode: "tense",
                instruction: "Écoutez la question et choisissez le temps approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782322/Q_ex_1_vaj6tr.mp3",
                text: "가장 친한 친구가 누구예요? 그 친구에 대해 이야기하세요.",
                translation: "Qui est votre meilleur ami ? Parlez de cet ami.",
                options: ["과거", "미래", "현재"],
                answer: "현재"
            },
            {
                type: "quiz",
                mode: "tense",
                instruction: "Écoutez la question et choisissez le temps approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785142/Q_ex_2_oi4b89.mp3",
                text: "어디에 여행을 가고 싶어요? 하고 싶은 여행에 대해 이야기하세요.",
                translation: "Où voulez-vous aller en voyage ? Parlez du voyage que vous désirez faire.",
                options: ["과거", "미래", "현재"],
                answer: "미래"
            },
            {
                type: "quiz",
                mode: "tense",
                instruction: "Écoutez la question et choisissez le temps approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785155/Q_ex_3_xoofmk.mp3",
                text: "시간이 있을 때 뭘 해요? 좋아하는 활동에 대해 이야기하세요.",
                translation: "Que faites-vous quand vous avez du temps ? Parlez des activités que vous aimez.",
                options: ["과거", "미래", "현재"],
                answer: "현재"
            },
            {
                type: "quiz",
                mode: "tense",
                instruction: "Écoutez la question et choisissez le temps approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785165/Q_ex_4_warvot.mp3",
                text: "내일은 친구의 생일이에요. 생일 파티 계획에 대해 이야기하세요.",
                translation: "Demain, c'est l'anniversaire d'un ami. Parlez des projets pour la fête d'anniversaire.",
                options: ["과거", "미래", "현재"],
                answer: "미래"
            },
            {
                type: "quiz",
                mode: "tense",
                instruction: "Écoutez la question et choisissez le temps approprié.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767785176/Q_ex_5_khlnli.mp3",
                text: "친구와 싸운 적이 있어요? 그 경험에 대해 이야기하세요.",
                translation: "Vous êtes-vous déjà disputé avec un ami ? Parlez de cette expérience.",
                options: ["과거", "미래", "현재"],
                answer: "과거"
            },
            {
                type: "outro",
                title: "Terminé !",
                content: "Bravo ! Dans l'Exercice 2, nous nous entraînerons à planifier les détails pour chaque question.",
                icon: "ph-check-circle"
            }
        ];

        // --- STATE ---
        let currentIndex = 0;
        let attempts = 0;
        let currentAudio = null;
        let isQuizSolved = false;
        let lessonCompleted = false;

        // Tone.js
        let synth, errorSynth, correctSynth, endSynth;

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const progressBar = document.getElementById('progress-bar');
        const pageIndicator = document.getElementById('page-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const appContainer = document.getElementById('app-container');

        // --- AUDIO FUNCTIONS ---
        async function initAudio() {
            await Tone.start();
            if (!synth) synth = new Tone.MembraneSynth().toDestination();
            if (!errorSynth) {
                errorSynth = new Tone.Synth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();
                errorSynth.volume.value = -5;
            }
            if (!correctSynth) {
                correctSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.5 }
                }).toDestination();
            }
            if (!endSynth) {
                endSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                endSynth.volume.value = -5;
            }
        }

        function playAudio(url) {
            // Stop current if any
            stopAudio();

            const btn = document.getElementById('main-audio-btn');
            const audio = new Audio(url);
            currentAudio = audio;

            if (btn) {
                btn.classList.remove('bg-gray-100', 'text-gray-600');
                btn.classList.add('bg-blue-600', 'text-white');
                btn.innerHTML = `<div class="playing-wave"><span></span><span></span><span></span></div>`;
            }

            audio.play().catch(e => console.error("Audio play failed", e));

            audio.onended = () => {
                resetAudioUI();
                currentAudio = null;
            };
        }

        function stopAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
                resetAudioUI();
            }
        }

        function resetAudioUI() {
            const btn = document.getElementById('main-audio-btn');
            if (btn) {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
                btn.innerHTML = `<i class="ph-fill ph-speaker-high text-4xl"></i>`;
            }
        }

        // --- RENDER LOGIC ---
        function renderSlide(index) {
            const slide = slides[index];
            isQuizSolved = false; 
            
            // Disable next for quiz
            if (slide.type === 'quiz') {
                attempts = 0;
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // Compact layout for quiz to avoid scrolling
            let html = `<div class="w-full h-full flex flex-col justify-center items-center p-4 sm:p-8 overflow-y-auto no-scrollbar fade-enter-active bg-white">`;
            html += `<div class="w-full max-w-xl flex flex-col gap-4 mx-auto z-10 text-center items-center">`;

            if (slide.type === 'cover') {
                html += `
                    <div class="space-y-6 py-4">
                        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 mb-2 mx-auto shadow-sm">
                            <i class="ph ${slide.icon} text-5xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 leading-tight break-keep mb-2">${slide.title}</h1>
                            ${slide.subtitle ? `<h2 class="text-xl sm:text-2xl text-blue-600 font-medium">${slide.subtitle}</h2>` : ''}
                        </div>
                    </div>
                `;
            } 
            else if (slide.type === 'outro') {
                html += `
                     <div class="space-y-8 py-4">
                         <div class="w-28 h-28 bg-green-50 rounded-full flex items-center justify-center text-green-600 mb-4 scale-110 mx-auto shadow-sm">
                            <i class="ph ${slide.icon} text-6xl"></i>
                        </div>
                        <h1 class="text-4xl font-bold text-gray-800">${slide.title}</h1>
                        <p class="text-xl text-gray-600 leading-relaxed max-w-md mx-auto">${slide.content}</p>
                    </div>
                `;
            }
            else if (slide.type === 'info') {
                html += `
                    <div class="space-y-6">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 mx-auto">
                            <i class="ph ${slide.icon} text-4xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">${slide.title}</h2>
                        <p class="text-gray-600 text-lg leading-relaxed break-keep max-w-lg mx-auto">
                            ${slide.content}
                        </p>
                    </div>
                `;
            }
            else if (slide.type === 'quiz') {
                // Determine Layout based on mode
                let optionsLayout = '';
                if (slide.mode === 'tense') {
                    optionsLayout = `flex flex-col sm:flex-row w-full justify-center gap-3`;
                } else {
                    optionsLayout = `grid grid-cols-2 gap-3 w-full`;
                }

                html += `
                    <div class="w-full text-center flex flex-col items-center">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 leading-relaxed">${slide.instruction}</h2>
                        
                        <!-- Audio Button -->
                        <button id="main-audio-btn" onclick="playAudio('${slide.audioUrl}')" 
                            class="w-20 h-20 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all flex items-center justify-center shadow-md transform active:scale-95 mb-4">
                            <i class="ph-fill ph-speaker-high text-4xl"></i>
                        </button>

                        <!-- Hint Area -->
                        <div id="hint-area" class="w-full max-w-lg mb-6 min-h-[2.5rem] flex flex-col items-center justify-start gap-2">
                            <!-- Hints injected here -->
                        </div>

                        <!-- Options -->
                        <div class="${optionsLayout} max-w-md mx-auto">
                            ${slide.options.map(opt => `
                                <button onclick="checkAnswer(this, '${opt}')" 
                                    class="option-btn bg-white py-3 px-4 rounded-xl text-lg font-medium text-gray-700 shadow-sm korean-text w-full">
                                    ${opt}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += `</div></div>`;
            mainContent.innerHTML = html;
            updateNav();
        }

        // --- QUIZ INTERACTION ---
        function checkAnswer(btn, selected) {
            if (isQuizSolved) return; 

            const slide = slides[currentIndex];
            initAudio(); 

            if (selected === slide.answer) {
                // Correct
                isQuizSolved = true;
                btn.classList.add('correct');
                correctSynth.triggerAttackRelease("C5", "8n");
                btn.innerHTML += ` <i class="ph-bold ph-check ml-2"></i>`;
                
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                // Wrong
                btn.classList.add('wrong');
                errorSynth.triggerAttackRelease("G2", "16n");
                setTimeout(() => btn.classList.remove('wrong'), 500);

                // Handle Attempts (Hints)
                handleAttempts(slide);
            }
        }

        function handleAttempts(slide) {
            attempts++;
            const hintArea = document.getElementById('hint-area');
            
            let hintButtonsHtml = '';
            
            if (attempts >= 1) {
                hintButtonsHtml += `
                    <button onclick="showText()" class="hint-btn text-blue-600 hover:text-blue-800">
                        <i class="ph-bold ph-book-open"></i> Lire le texte
                    </button>
                `;
            }
            if (attempts >= 2) {
                hintButtonsHtml += `
                    <button onclick="showTrans()" class="hint-btn text-green-600 hover:text-green-800 ml-4">
                        <i class="ph-bold ph-translate"></i> Voir la traduction
                    </button>
                `;
            }

            const isTextVisible = document.getElementById('revealed-text')?.classList.contains('hidden') === false;
            const isTransVisible = document.getElementById('revealed-trans')?.classList.contains('hidden') === false;

            const contentHtml = `
                <div id="revealed-text" class="${isTextVisible ? '' : 'hidden'} mt-1 w-full p-3 bg-gray-50 rounded-lg text-gray-800 korean-text font-medium border border-gray-200 text-sm sm:text-base">
                    ${slide.text}
                </div>
                <div id="revealed-trans" class="${isTransVisible ? '' : 'hidden'} mt-1 w-full p-2 bg-green-50 rounded-lg text-green-800 text-xs sm:text-sm border border-green-200">
                    ${slide.translation}
                </div>
            `;

            hintArea.innerHTML = `<div class="flex justify-center w-full">${hintButtonsHtml}</div>` + contentHtml;
        }

        window.showText = function() {
            const el = document.getElementById('revealed-text');
            if(el) el.classList.remove('hidden');
        };

        window.showTrans = function() {
            const el = document.getElementById('revealed-trans');
            if(el) el.classList.remove('hidden');
        };

        // --- NAVIGATION & RESIZE ---
        function handleResize() {
            const aspect = window.innerWidth / window.innerHeight;
            const isMobile = aspect < 1;
            if (isMobile) {
                document.body.classList.add('mobile-mode');
                appContainer.style.width = '100vw';
                appContainer.style.height = '100vh';
            } else {
                document.body.classList.remove('mobile-mode');
                appContainer.style.width = '';
                appContainer.style.height = '';
            }
            renderSlide(currentIndex);
        }
        window.addEventListener('resize', handleResize);
        setTimeout(() => handleResize(), 100);

        function updateNav() {
            const progress = ((currentIndex + 1) / slides.length) * 100;
            progressBar.style.width = `${progress}%`;
            pageIndicator.textContent = `${currentIndex + 1} / ${slides.length}`;

            prevBtn.disabled = currentIndex === 0;

            if (currentIndex === slides.length - 1) {
                nextBtn.style.display = 'none';
                if (!lessonCompleted) {
                    completeLesson();
                    lessonCompleted = true;
                }
            } else {
                nextBtn.style.display = 'flex';
                nextBtn.innerHTML = `<span class="hidden sm:inline">Suivant</span> <i class="ph-bold ph-arrow-right"></i>`;
                lessonCompleted = false;
            }
        }

        async function nextSlide() {
            stopAudio(); 
            await initAudio();
            if (synth) synth.triggerAttackRelease("C2", "32n");
            if (currentIndex < slides.length - 1) {
                currentIndex++;
                renderSlide(currentIndex);
            }
        }

        async function prevSlide() {
            stopAudio(); 
            await initAudio();
            if (synth) synth.triggerAttackRelease("C2", "32n");
            if (currentIndex > 0) {
                currentIndex--;
                renderSlide(currentIndex);
            }
        }

        function completeLesson() {
            if (endSynth) {
                endSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
            }
            console.log("Lesson Complete");
            window.parent.postMessage({ type: 'lesson_complete' }, '*');
        }

        // --- INIT ---
        renderSlide(0);

    </script>
</body>
</html>
