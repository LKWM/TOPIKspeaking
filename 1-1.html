<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Question 1 - Répondre aux questions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Nunito:wght@400;600;700&display=swap');

        body {
            font-family: 'Nunito', 'Noto Sans KR', sans-serif;
            overflow: hidden;
            background-color: #F3F4F6;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .slide-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
            width: 100%;
        }

        /* 커스텀 오디오 버튼 스타일 */
        .custom-audio-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #4F46E5; /* Indigo 600 */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }

        .custom-audio-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 재생 중일 때 스타일 (클릭 불가) */
        .custom-audio-btn.playing {
            background-color: #E0E7FF; /* Indigo 100 */
            color: #4F46E5;
            cursor: not-allowed;
            pointer-events: none; /* 클릭 방지 */
            animation: pulse 1.5s infinite;
            transform: none; /* active 효과 제거 */
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }

        /* 텍스트 강조 박스 수정: 중앙 정렬 */
        .korean-example {
            background-color: #FFFFFF;
            border-left: 4px solid #6366F1;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            text-align: center; /* 텍스트 중앙 정렬 요청 반영 */
            margin-left: auto;
            margin-right: auto;
        }

        .highlight-keyword {
            color: #4F46E5;
            font-weight: 700;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Outro 페이지 균일한 마진을 위한 유틸리티 */
        .outro-spacer {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center text-gray-800">

    <!-- 메인 컨테이너 -->
    <div id="app-container" class="relative w-full h-full max-w-5xl max-h-[900px] flex flex-col bg-white sm:rounded-2xl shadow-2xl overflow-hidden">
        
        <!-- 헤더: 진행바 -->
        <div class="h-2 bg-gray-200 w-full">
            <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
        </div>

        <!-- 메인 컨텐츠 영역 -->
        <div id="content-area" class="flex-1 overflow-hidden relative w-full">
            <!-- 자바스크립트로 내용 주입 -->
        </div>

        <!-- 네비게이션 -->
        <div id="navigation" class="h-20 bg-gray-50 border-t border-gray-200 flex items-center justify-between px-6 hidden z-10">
            <button id="prev-btn" class="flex items-center text-gray-500 hover:text-indigo-600 font-bold transition-colors disabled:opacity-30 disabled:cursor-not-allowed select-none">
                <i class="ph ph-caret-left text-2xl mr-2"></i> Précédent
            </button>
            
            <!-- 페이지 번호 디스플레이 삭제됨 -->
            <div class="flex-1"></div>

            <button id="next-btn" class="flex items-center text-indigo-600 hover:text-indigo-800 font-bold transition-colors select-none">
                Suivant <i class="ph ph-caret-right text-2xl ml-2"></i>
            </button>
        </div>
    </div>

    <script>
        // --- 데이터 ---
        const slides = [
            {
                type: 'cover',
                title: "문항 1 - 질문에 대답하기",
                subtitle: "Question 1 - Répondre aux questions",
                content: ""
            },
            {
                type: 'content',
                content: "La Question 1 consiste à écouter une question et à y répondre.<br><br>Les questions portent sur des sujets simples de la vie quotidienne. Après avoir écouté la question, vous disposez de <strong>20 secondes de préparation</strong>. Une fois les 20 secondes écoulées, vous devez <strong>répondre pendant 30 secondes</strong>."
            },
            {
                type: 'example',
                content: "Les questions portent sur vous-même, vos proches, des objets, votre quotidien, vos expériences passées ou vos projets futurs.<br>Vous devez écouter attentivement pour comprendre exactement ce qui est demandé.",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782322/Q_ex_1_vaj6tr.mp3",
                exampleTitle: "Exemple de question",
                exampleText: "가장 친한 친구가 누구예요? 그 친구에 대해 이야기하세요."
            },
            {
                type: 'example',
                // Page 3 번역 수정
                content: "Pendant les 20 secondes de préparation, vous pouvez organiser et résumer ce que vous allez dire. Vous devez planifier les détails liés au sujet.<br><br>Comme le temps de préparation est court, vous ne pouvez pas écrire tout votre discours. Vous devez noter des mots-clés et être capable de parler directement en les utilisant.",
                exampleTitle: "Exemple de mots-clés",
                exampleText: "가장 친한 친구, 민수, 고등학교, 친절하다, 키가 크다"
            },
            {
                type: 'example',
                content: "Parlez pendant 30 secondes en utilisant vos mots-clés.<br><br><strong>Conseil :</strong> Visez 2 à 3 phrases correctes en utilisant la grammaire de base.",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782323/R_ex_1_1_ef25g9.mp3",
                exampleTitle: "Exemple de réponse",
                exampleText: "제 가장 친한 친구는 민수예요. 저는 고등학교에서 민수를 만났어요. 민수는 친절하고 키가 커요."
            },
            {
                type: 'example',
                content: "<strong>Conseil :</strong> Entraînez-vous à faire 4 à 5 phrases plus longues en utilisant des phrases complexes et des conjonctions.<br>L'utilisation d'un vocabulaire varié aide à obtenir un meilleur score.",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782326/R_ex_1_2_chleqe.mp3",
                exampleTitle: "Exemple de réponse",
                exampleText: "저는 고등학교 때 민수와 같은 반이었어요. 그때는 별로 친하지 않았지만 같은 대학교에 가면서 아주 가까워졌어요. 민수는 친절하고 키도 커서 친구들에게 인기가 많았고 공부도 정말 잘했어요."
            },
            {
                type: 'content',
                content: "<strong>Conseil :</strong> À ce niveau, vous devez utiliser divers temps et construire un discours cohérent de plus de 6 phrases.<br><br>Comme le sujet est quotidien, privilégiez une prononciation naturelle et une structure logique plutôt que d'essayer d'utiliser un vocabulaire trop complexe ou peu naturel."
            },
            {
                type: 'example',
                content: "Écoutez cet exemple de réponse de niveau avancé.",
                audio: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782330/R_ex_1_3_fpyxg8.mp3",
                exampleTitle: "Exemple de réponse",
                exampleText: "저는 고등학교 1학년 때 학교에 아는 사람이 많지 않아서 주로 혼자 시간을 보냈어요. 그런데 같은 반에 있던 민수라는 친구가 저에게 먼저 말을 걸어줬어요. 우리는 같이 점심도 먹고 농구도 자주 하면서 점점 더 가까워졌어요. 민수는 키가 커서 농구를 정말 잘했기 때문에 다른 친구들에게도 인기가 많았어요. 저는 민수 덕분에 많은 친구들을 사귈 수 있었고, 어른이 된 지금도 민수는 제 가장 친한 친구예요."
            },
            {
                type: 'outro',
                title: "", 
                content: "Maintenant, passons à l'exercice 1 pour analyser les différentes questions du type 1 !"
            }
        ];

        // --- 상태 관리 ---
        let currentIndex = 0;
        let completionSynth = null;
        let clickSynth = null;
        let audioContextStarted = false;
        let currentAudio = null;
        let currentBtn = null;
        let hasOutroPlayed = false; // Outro 재생 플래그

        // --- DOM 요소 ---
        const appContainer = document.getElementById('app-container');
        const contentArea = document.getElementById('content-area');
        const navigation = document.getElementById('navigation');
        const progressBar = document.getElementById('progress-bar');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        // Page num display removed

        // --- 초기화 ---
        async function initAudio() {
            if (!audioContextStarted) {
                await Tone.start();
                
                // [FIX] PolySynth로 변경하여 배열(화음) 입력 처리 가능하게 수정
                completionSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                
                clickSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.008,
                    octaves: 2,
                    oscillator: { type: "sine" },
                    envelope: {
                        attack: 0.001,
                        decay: 0.1,
                        sustain: 0,
                        release: 0.1,
                        attackCurve: "exponential"
                    }
                }).toDestination();
                
                audioContextStarted = true;
            }
        }

        function playClickSound() {
            if (clickSynth && audioContextStarted) {
                clickSynth.triggerAttackRelease("F4", "32n"); 
            }
        }

        // --- 렌더링 로직 ---
        function renderSlide(index) {
            stopCurrentAudio(); // 페이지 이동 시 오디오 강제 정지

            const slide = slides[index];
            const isLastPage = index === slides.length - 1;
            
            // 프로그레스 바 업데이트
            const progress = ((index + 1) / slides.length) * 100;
            progressBar.style.width = `${progress}%`;

            // HTML 생성
            let html = '';
            
            if (slide.type === 'cover') {
                navigation.classList.add('hidden');
                html = `
                    <div class="slide-content fade-in">
                        <div class="bg-indigo-100 p-6 rounded-full mb-6">
                            <i class="ph-fill ph-chat-circle-text text-6xl text-indigo-600"></i>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-2">${slide.title}</h1>
                        <p class="text-xl text-gray-600 font-medium">${slide.subtitle}</p>
                        
                        <button onclick="startLesson()" class="mt-12 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-10 rounded-full shadow-lg transform transition hover:scale-105 flex items-center">
                            Commencer <i class="ph-bold ph-arrow-right ml-2"></i>
                        </button>
                    </div>
                `;
            } else {
                navigation.classList.remove('hidden');
                
                // 기본 컨텐츠
                let contentHtml = '';
                
                if (slide.title) {
                    contentHtml += `<h2 class="text-2xl font-bold text-gray-800 mb-6">${slide.title}</h2>`;
                }

                // Outro 페이지일 경우 레이아웃 조정
                if (slide.type === 'outro') {
                    contentHtml += `
                        <div class="flex flex-col items-center justify-center h-full">
                             <div class="text-indigo-600 font-semibold flex flex-col items-center animate-bounce mb-8">
                                <i class="ph-fill ph-star text-6xl"></i>
                            </div>
                            <p class="text-xl text-gray-700 leading-relaxed max-w-2xl font-medium">${slide.content}</p>
                        </div>
                    `;
                } else {
                    // 일반 페이지
                    contentHtml += `<p class="text-lg text-gray-600 leading-relaxed mb-6 max-w-2xl">${slide.content}</p>`;

                    // 오디오 추가 (정지 불가 로직 적용)
                    if (slide.audio) {
                        contentHtml += `
                            <div class="flex flex-col items-center mb-6">
                                <button id="audio-btn-${index}" class="custom-audio-btn" onclick="playAudio('${slide.audio}', 'audio-btn-${index}')">
                                    <i class="ph-fill ph-play"></i>
                                </button>
                                <p class="text-xs text-gray-400 mt-2 font-medium">Écouter</p>
                            </div>
                        `;
                    }

                    // 예시 텍스트 추가 (중앙 정렬)
                    if (slide.exampleText) {
                        contentHtml += `
                            <div class="korean-example">
                                <div class="text-xs font-bold text-indigo-500 uppercase mb-2 tracking-wide border-b border-indigo-100 pb-1 inline-block px-4">${slide.exampleTitle || 'Exemple'}</div>
                                <div class="text-lg font-medium text-gray-800 font-['Noto_Sans_KR'] leading-relaxed word-keep break-keep">
                                    ${slide.exampleText}
                                </div>
                            </div>
                        `;
                    }
                }

                html = `<div class="slide-content fade-in overflow-y-auto w-full">${contentHtml}</div>`;
            }

            contentArea.innerHTML = html;
            
            prevBtn.disabled = index === 0;
            
            if (isLastPage) {
                nextBtn.innerHTML = `Terminer <i class="ph ph-check text-2xl ml-2"></i>`;
                // 마지막 페이지 도달 시 종료음 1회만 재생
                playCompletion();
            } else {
                nextBtn.innerHTML = `Suivant <i class="ph ph-caret-right text-2xl ml-2"></i>`;
            }
        }

        // --- 오디오 제어 (정지 불가) ---
        function stopCurrentAudio() {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            if (currentBtn) {
                currentBtn.innerHTML = '<i class="ph-fill ph-play"></i>';
                currentBtn.classList.remove('playing');
                currentBtn = null;
            }
        }

        function playAudio(src, btnId) {
            const btn = document.getElementById(btnId);
            
            // 재생 중이면 아무것도 하지 않음 (정지 불가)
            if (currentBtn === btn) return;

            // 다른 오디오가 재생 중이라면 정지
            stopCurrentAudio();

            const audio = new Audio(src);
            
            // 재생 종료 이벤트
            audio.onended = () => {
                btn.innerHTML = '<i class="ph-fill ph-play"></i>';
                btn.classList.remove('playing');
                currentAudio = null;
                currentBtn = null;
            };
            
            audio.play().catch(e => console.error("Audio play error:", e));
            
            currentAudio = audio;
            currentBtn = btn;
            
            // UI 업데이트: 재생 중 아이콘 및 클릭 방지
            btn.innerHTML = '<i class="ph-fill ph-speaker-high"></i>';
            btn.classList.add('playing');
        }

        // --- 종료 로직 ---
        function playCompletion() {
            // 이미 재생했다면 실행하지 않음
            if (hasOutroPlayed) return;
            
            if (completionSynth && audioContextStarted) {
                completionSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n");
            }
            window.parent.postMessage({ type: 'lesson_complete' }, '*');
            hasOutroPlayed = true; // 재생 완료 플래그 설정
        }

        // --- 네비게이션 함수 ---
        async function startLesson() {
            await initAudio(); 
            nextSlide();
        }

        function nextSlide() {
            if (currentIndex < slides.length - 1) {
                playClickSound();
                currentIndex++;
                renderSlide(currentIndex);
            }
        }

        function prevSlide() {
            if (currentIndex > 0) {
                playClickSound();
                currentIndex--;
                
                // 뒤로 가면 Outro 플래그 초기화 (다시 마지막 페이지 오면 소리 나게)
                if (hasOutroPlayed) {
                    hasOutroPlayed = false;
                }
                
                renderSlide(currentIndex);
            }
        }

        // 초기 실행
        renderSlide(0);

        prevBtn.addEventListener('click', prevSlide);
        nextBtn.addEventListener('click', nextSlide);

        window.startLesson = startLesson;
        window.playAudio = playAudio; // toggleAudio -> playAudio
        window.nextSlide = nextSlide; 

    </script>
</body>
</html>
