<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOPIK 말하기 Question 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563EB;
            --secondary-color: #10B981;
            --bg-color: #F8FAFC;
            --text-main: #1E293B;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow: hidden; /* Global scroll lock */
            width: 100vw;
            height: 100vh;
            color: var(--text-main);
        }

        #app-container {
            background-color: var(--bg-color);
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Transitions */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 0.4s, transform 0.4s; }
        
        .btn-hover:active { transform: scale(0.95); }
        
        /* Audio Wave */
        .playing-wave { display: flex; align-items: center; justify-content: center; }
        .playing-wave span {
            display: inline-block;
            width: 3px; height: 12px; background-color: white;
            animation: wave 1s infinite ease-in-out; margin: 0 1px; border-radius: 2px;
        }
        .playing-wave span:nth-child(2) { animation-delay: 0.1s; }
        .playing-wave span:nth-child(3) { animation-delay: 0.2s; }
        @keyframes wave { 0%, 100% { height: 12px; } 50% { height: 20px; } }

        .highlight-box {
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
            border-left: 4px solid var(--primary-color);
        }

        .korean-text { font-family: 'Noto Sans KR', sans-serif; word-break: keep-all; }
        
        .process-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            min-height: 0; /* Allow shrinking */
        }
        
        /* Typography Clamp for responsiveness */
        .txt-title { font-size: clamp(1.25rem, 3.5vh, 2.25rem); }
        .txt-subtitle { font-size: clamp(1rem, 2.5vh, 1.5rem); }
        .txt-body { font-size: clamp(0.875rem, 2vh, 1.125rem); }
        .txt-kr { font-size: clamp(1rem, 2.2vh, 1.35rem); }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Header -->
        <header class="h-12 bg-white border-b border-gray-200 flex items-center justify-between px-6 shrink-0 z-10">
            <div class="flex items-center gap-2 text-blue-600 font-bold">
                <i class="ph-fill ph-chat-circle-text text-xl"></i>
                <span class="text-sm tracking-wide">TOPIK 말하기</span>
            </div>
            <div class="text-xs text-gray-400 font-medium">문항 1</div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 w-full mx-auto overflow-hidden relative flex flex-col">
            <!-- Content Injected Here -->
        </main>

        <!-- Footer / Navigation -->
        <footer id="footer-nav" class="h-16 bg-white border-t border-gray-200 flex items-center justify-between px-4 sm:px-8 shrink-0 z-10 relative">
            <div class="absolute top-0 left-0 h-1 bg-gray-100 w-full">
                <div id="progress-bar" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
            </div>

            <button id="prev-btn" onclick="prevSlide()" class="btn-hover flex items-center gap-2 text-gray-500 font-medium px-4 py-2 rounded-lg hover:bg-gray-100 disabled:opacity-30 transition-colors" disabled>
                <i class="ph-bold ph-arrow-left"></i>
                <span class="hidden sm:inline">Précédent</span>
            </button>

            <span id="page-indicator" class="text-sm font-semibold text-gray-600 font-mono">1 / 8</span>

            <button id="next-btn" onclick="nextSlide()" class="btn-hover flex items-center gap-2 bg-blue-600 text-white font-medium px-6 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                <span class="hidden sm:inline">Suivant</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
        </footer>
    </div>

    <script>
        // --- DATA ---
        const slides = [
            {
                type: "cover",
                title: "문항 1 - 질문에 대답하기",
                subtitle: "Question 1 - Répondre à la question",
                desc: "",
                icon: "ph-microphone-stage"
            },
            {
                type: "split",
                title: "Aperçu de la Question 1",
                contentFr: "La question 1 consiste à écouter une question et à y répondre. Les questions portent sur des sujets simples de la vie quotidienne.",
                visualType: "process",
                cards: [
                    { icon: "ph-ear", title: "Écoute", sub: "Question" },
                    { icon: "ph-timer", title: "Préparation", sub: "20 sec" },
                    { icon: "ph-microphone", title: "Réponse", sub: "30 sec" }
                ]
            },
            {
                type: "split",
                title: "Comprendre le Sujet",
                contentFr: "Sujets fréquents : Vous-même, vos proches, le quotidien, expériences passées, projets futurs.<br>Il est crucial de bien comprendre la demande tout en écoutant la question.",
                visualType: "example",
                koreanText: "가장 친한 친구가 누구예요? 그 친구에 대해 이야기하세요.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782322/Q_ex_1_vaj6tr.mp3"
            },
            {
                type: "split",
                title: "Préparation (20 sec)",
                contentFr: "Pendant les 20 secondes, organisez et résumez ce que vous allez dire. Planifiez les détails liés au sujet.<br>Le temps étant court, vous ne pouvez pas tout rédiger. Notez des <strong>mots-clés</strong> et utilisez-les pour parler directement.",
                visualType: "note",
                noteTitle: "Mots-clés (Exemple)",
                koreanText: "가장 친한 친구, 민수, 고등학교, 친절하다, 키가 크다"
            },
            {
                type: "split",
                title: "Niveau Débutant",
                contentFr: "L'expression orale dure 30 secondes en regardant vos mots-clés.<br><span class='text-blue-600 font-bold'>Conseil :</span> Visez 2 à 3 phrases correctes en respectant la grammaire de base.",
                visualType: "example",
                koreanText: "제 가장 친한 친구는 민수예요. 저는 고등학교에서 민수를 만났어요. 민수는 친절하고 키가 커요.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782323/R_ex_1_1_ef25g9.mp3"
            },
            {
                type: "split",
                title: "Niveau Intermédiaire",
                contentFr: "<span class='text-green-600 font-bold'>Astuce :</span> Utilisez des phrases complexes et des conjonctions pour construire 4 à 5 phrases plus longues. Varier le vocabulaire aide à obtenir un meilleur score.",
                visualType: "example",
                koreanText: "저는 고등학교 때 민수와 같은 반이었어요. 그때는 별로 친하지 않았지만 같은 대학교에 가면서 아주 가까워졌어요. 민수는 친절하고 키도 커서 친구들에게 인기가 많았고 공부도 정말 잘했어요.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782326/R_ex_1_2_chleqe.mp3"
            },
            {
                type: "split",
                title: "Niveau Avancé",
                contentFr: "<span class='text-purple-600 font-bold'>Conseil :</span> Utilisez divers temps verbaux et construisez un discours cohérent de plus de 6 phrases. S'agissant de sujets quotidiens, privilégiez une prononciation naturelle et une structure logique plutôt qu'un vocabulaire trop complexe.",
                visualType: "text-only", 
                contentList: [
                    "Variété des temps (passé/présent)",
                    "Structure logique (Cause/Effet)",
                    "Prononciation naturelle"
                ]
            },
            {
                type: "full-example",
                title: "Exemple Avancé",
                contentFr: "Écoutez une réponse de niveau avancé.",
                koreanText: "저는 고등학교 1학년 때 학교에 아는 사람이 많지 않아서 주로 혼자 시간을 보냈어요. 그런데 같은 반에 있던 민수라는 친구가 저에게 먼저 말을 걸어줬어요. 우리는 같이 점심도 먹고 농구도 자주 하면서 점점 더 가까워졌어요. 민수는 키가 커서 농구를 정말 잘했기 때문에 다른 친구들에게도 인기가 많았어요. 저는 민수 덕분에 많은 친구들을 사귈 수 있었고, 어른이 된 지금도 민수는 제 가장 친한 친구예요.",
                audioUrl: "https://res.cloudinary.com/de76i94ia/video/upload/v1767782330/R_ex_1_3_fpyxg8.mp3"
            },
            {
                type: "outro",
                title: "Terminé !",
                contentFr: "Maintenant, passez à l'exercice 1 et analysez les différentes questions de la question 1 !",
                icon: "ph-check-circle"
            }
        ];

        // --- STATE ---
        let currentIndex = 0;
        let currentAudio = null;
        let lessonCompleted = false; 
        let clickSynth, endSynth;

        // --- DOM ---
        const mainContent = document.getElementById('main-content');
        const progressBar = document.getElementById('progress-bar');
        const pageIndicator = document.getElementById('page-indicator');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // --- AUDIO ---
        async function initAudio() {
            await Tone.start();
            if (!clickSynth) {
                clickSynth = new Tone.MembraneSynth({ pitchDecay: 0.008, octaves: 2, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                clickSynth.volume.value = -10;
            }
            if (!endSynth) {
                endSynth = new Tone.PolySynth(Tone.Synth).toDestination();
                endSynth.volume.value = -5;
            }
        }

        function playAudio(url, btnId) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                resetAudioButtons();
            }
            if (currentAudio && currentAudio.src === url && !currentAudio.paused) {
                currentAudio = null;
                return;
            }
            const btn = document.getElementById(btnId);
            const audio = new Audio(url);
            currentAudio = audio;
            btn.classList.remove('bg-gray-100', 'text-gray-600');
            btn.classList.add('bg-blue-600', 'text-white');
            btn.innerHTML = `<div class="playing-wave"><span></span><span></span><span></span></div>`;
            audio.play().catch(e => console.error("Audio play failed", e));
            audio.onended = () => { resetAudioButtons(); currentAudio = null; };
        }

        function resetAudioButtons() {
            document.querySelectorAll('.audio-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
                btn.innerHTML = `<i class="ph-fill ph-speaker-high text-2xl"></i>`;
            });
        }

        // --- RENDER ---
        function renderSlide(index) {
            const slide = slides[index];
            
            // KEY CHANGE: Removed 'h-full' from inner wrapper.
            // Using 'justify-center' on the outer flex container to center the inner block.
            // The inner block uses 'max-h-full' to respect boundaries but shrink if needed.
            
            let html = `<div class="w-full h-full flex flex-col justify-center items-center p-4 sm:p-6 fade-enter-active bg-white">`;
            
            // Inner Wrapper: Groups everything together. 
            // Removed gap-[2vh] in favor of flex shrinking logic or smaller fixed gaps to keep items close.
            html += `<div class="w-full max-w-4xl flex flex-col gap-4 max-h-full justify-center">`;

            if (slide.type === 'cover') {
                html += `
                    <div class="flex flex-col items-center justify-center text-center gap-6 shrink-0">
                        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shadow-sm shrink-0">
                            <i class="ph ${slide.icon} text-5xl"></i>
                        </div>
                        <div class="flex flex-col gap-2">
                            <h1 class="txt-title font-bold text-gray-800 leading-tight break-keep">${slide.title}</h1>
                            <h2 class="txt-subtitle text-blue-600 font-medium">${slide.subtitle}</h2>
                        </div>
                        ${slide.desc ? `<p class="txt-body text-gray-500">${slide.desc}</p>` : ''}
                    </div>
                `;
            } 
            else if (slide.type === 'outro') {
                html += `
                    <div class="flex flex-col items-center justify-center text-center gap-8 shrink-0">
                         <div class="w-28 h-28 bg-green-50 rounded-full flex items-center justify-center text-green-600 shadow-sm shrink-0">
                            <i class="ph ${slide.icon} text-6xl"></i>
                        </div>
                        <h1 class="txt-title font-bold text-gray-800">${slide.title}</h1>
                        <p class="txt-subtitle text-gray-600 leading-relaxed max-w-md mx-auto">${slide.contentFr}</p>
                    </div>
                `;
            }
            else {
                // UNIFIED LAYOUT for Content Slides
                // Top: Description (Shrinkable)
                html += `
                    <div class="flex flex-col gap-2 text-center sm:text-left shrink-0">
                        <h2 class="txt-title font-bold text-gray-800 leading-tight">${slide.title}</h2>
                        <p class="txt-body text-gray-600 leading-relaxed break-keep">
                            ${slide.contentFr}
                        </p>
                    </div>
                `;

                // Bottom: Visual/Audio/Text
                // 'min-h-0' and 'shrink' allows this container to reduce size if screen is short
                // Removed 'flex-1' to prevent forced spacing.
                let bottomContent = '';

                // Process Cards
                if (slide.visualType === 'process') {
                    bottomContent = `
                        <div class="flex flex-col sm:flex-row gap-3 w-full justify-center items-center shrink min-h-0 overflow-hidden">
                            ${slide.cards.map(card => `
                                <div class="process-card w-full sm:w-1/3 shrink">
                                    <i class="ph-fill ${card.icon} text-3xl text-blue-500 mb-1 shrink-0"></i>
                                    <div class="font-bold text-gray-800 text-lg leading-tight shrink-0">${card.title}</div>
                                    <div class="text-sm text-gray-500 font-medium shrink-0">${card.sub}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } 
                // Note style
                else if (slide.visualType === 'note') {
                    bottomContent = `
                        <div class="w-full flex items-center justify-center shrink min-h-0">
                            <div class="relative bg-yellow-50 p-6 rounded-xl shadow-sm border border-yellow-200 w-full max-w-lg transform -rotate-1 flex flex-col justify-center items-center gap-2 shrink overflow-hidden">
                                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-24 h-4 bg-yellow-200/60 rounded-sm shrink-0"></div>
                                <h3 class="text-xs font-bold text-yellow-800 uppercase tracking-wider flex items-center gap-2 shrink-0">
                                    <i class="ph-fill ph-note-pencil"></i> ${slide.noteTitle}
                                </h3>
                                <p class="txt-kr font-medium text-gray-800 leading-relaxed text-center break-keep shrink overflow-y-auto no-scrollbar max-h-full">
                                    ${slide.koreanText}
                                </p>
                            </div>
                        </div>
                    `;
                }
                // Text List
                else if (slide.visualType === 'text-only') {
                     bottomContent = `
                        <div class="w-full flex items-center justify-center shrink min-h-0">
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 w-full shrink overflow-y-auto no-scrollbar">
                                <ul class="space-y-2">
                                    ${slide.contentList.map(item => `
                                        <li class="flex items-start gap-3 text-gray-700 font-medium txt-body">
                                            <i class="ph-fill ph-check-circle text-purple-500 text-xl mt-0.5 shrink-0"></i>
                                            <span>${item}</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                     `;
                }
                // Examples (Audio + Box)
                else if (slide.visualType === 'example' || slide.type === 'full-example') {
                    bottomContent = `
                        <div class="flex flex-col gap-3 w-full items-center justify-center shrink min-h-0 overflow-hidden">
                            ${slide.audioUrl ? `
                                <button id="audio-${index}" onclick="playAudio('${slide.audioUrl}', 'audio-${index}')" 
                                    class="audio-btn w-14 h-14 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-all flex items-center justify-center shadow-md transform active:scale-95 shrink-0">
                                    <i class="ph-fill ph-speaker-high text-2xl"></i>
                                </button>
                            ` : ''}
                            <div class="${slide.type === 'full-example' ? 'bg-gray-50 border-gray-200' : 'highlight-box'} p-4 rounded-lg shadow-sm border w-full text-center flex items-center justify-center shrink overflow-hidden min-h-0">
                                <p class="txt-kr text-gray-800 leading-relaxed break-keep overflow-y-auto no-scrollbar max-h-full">
                                    ${slide.koreanText}
                                </p>
                            </div>
                        </div>
                    `;
                }

                html += bottomContent;
            }

            html += `</div></div>`;
            mainContent.innerHTML = html;
            updateNav();
        }

        // --- NAVIGATION LOGIC ---
        function updateNav() {
            const progress = ((currentIndex + 1) / slides.length) * 100;
            progressBar.style.width = `${progress}%`;
            pageIndicator.textContent = `${currentIndex + 1} / ${slides.length}`;

            prevBtn.disabled = currentIndex === 0;
            
            if (currentIndex === slides.length - 1) {
                nextBtn.style.display = 'none'; 
                if (!lessonCompleted) {
                    completeLesson();
                    lessonCompleted = true;
                }
            } else {
                nextBtn.style.display = 'flex';
                nextBtn.innerHTML = `<span class="hidden sm:inline">Suivant</span> <i class="ph-bold ph-arrow-right"></i>`;
                lessonCompleted = false; 
            }
        }

        async function nextSlide() {
            await initAudio(); 
            if (clickSynth) clickSynth.triggerAttackRelease("C2", "32n");
            if (currentIndex < slides.length - 1) {
                currentIndex++;
                renderSlide(currentIndex);
            }
        }

        async function prevSlide() {
            await initAudio();
            if (clickSynth) clickSynth.triggerAttackRelease("C2", "32n");
            if (currentIndex > 0) {
                currentIndex--;
                renderSlide(currentIndex);
            }
        }

        function completeLesson() {
            if (endSynth) {
                endSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n");
            }
            console.log("Lesson Complete - PostMessage Sent");
            window.parent.postMessage({ type: 'lesson_complete' }, '*');
        }

        // --- INIT ---
        renderSlide(0);

    </script>
</body>
</html>
